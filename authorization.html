<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Authorization</title>
<style>
@import 'assets/css/spring-ident.css';

.listingblock .switch {
    border-style: none;
    display: inline-block;
    position: relative;
    bottom: -3px;
}

.listingblock .switch--item {
    padding: 10px;
    background-color: #e6e1dc;
    color: #282c34;
    display: inline-block;
    cursor: pointer;
    border-top-left-radius: 4px;
    border-top-right-radius: 4px;
}

.listingblock .switch--item:not(:first-child) {
    border-style: none;
}

.listingblock .switch--item.selected {
    background-color: #282c34;
    color: #e6e1dc;
}

.listingblock pre.highlightjs {
    padding: 0;
}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
.hidden {
	display: none;
}

.switch {
	border-width: 1px 1px 0 1px;
	border-style: solid;
	border-color: #7a2518;
	display: inline-block;
}

.switch--item {
	padding: 10px;
	background-color: #ffffff;
	color: #7a2518;
	display: inline-block;
	cursor: pointer;
}

.switch--item:not(:first-child) {
	border-width: 0 0 0 1px;
	border-style: solid;
	border-color: #7a2518;
}

.switch--item.selected {
	background-color: #7a2519;
	color: #ffffff;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>
<script type="text/javascript">
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function globalSwitch() {
	$('.switch--item').each(function() {
		var blockId = blockIdForSwitchItem($(this));
		$(this).off('click');
		$(this).on('click', function() {
			selectedText = $(this).text()
			window.localStorage.setItem(blockId, selectedText);
			$(".switch--item").filter(function() {
				return blockIdForSwitchItem($(this)) === blockId;
			}).filter(function() {
				return $(this).text() === selectedText;
			}).each(function() {
				select($(this))
			});
		});
		if ($(this).text() === window.localStorage.getItem(blockId)) {
			select($(this))
		}
	});
}

function blockIdForSwitchItem(item) {
	idComponents = []
	idComponents.push(item.text().toLowerCase());
	item.siblings(".switch--item").each(function(index, sibling) {
		idComponents.push($(sibling).text().toLowerCase());
	});
	return idComponents.sort().join("-")
}

function select(selected) {
	selected.addClass('selected');
	selected.siblings().removeClass('selected');
	selectedContent = selected.parent().siblings(".content").eq(selected.index())
	selectedContent.removeClass('hidden');
	selectedContent.siblings().addClass('hidden');
}

$(addBlockSwitches);
$(globalSwitch);

</script>

</head>
<body id="authorization" class="book toc2 toc-left">
<div id="header">
<h1>Authorization</h1>
<div class="details">
<span id="revnumber">version 1.0.0</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#what-is-keyclaok">1. What is Keyclaok</a>
<ul class="sectlevel2">
<li><a href="#qué-se-necesita">1.1. ¿Qué se necesita?</a></li>
<li><a href="#ejemplos">1.2. Ejemplos</a>
<ul class="sectlevel3">
<li><a href="#curl">1.2.1. CURL</a></li>
<li><a href="#kotlin">1.2.2. Kotlin</a></li>
</ul>
</li>
<li><a href="#response">1.3. Response</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="what-is-keyclaok"><a class="anchor" href="#what-is-keyclaok"></a>1. What is Keyclaok</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Keycloak is a single sign on solution for web apps and RESTful web services. The goal of Keycloak is to make security simple so that it is easy for application developers to secure the apps and services they have deployed in their organization. Security features that developers normally have to write for themselves are provided out of the box and are easily tailorable to the individual requirements of your organization. For more information visit <a href="https://www.keycloak.org/documentation">Keyclaok Oficial Site</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Meltsan Solutions utiliza esta implementación para la autenticación y autirización de los consumidores de sus APIs</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="qué-se-necesita"><a class="anchor" href="#qué-se-necesita"></a>1.1. ¿Qué se necesita?</h3>
<div class="paragraph">
<p>Para poder consumir los servicios de Meltsan Solutions necesitas de los siguietes datos.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>AUTHORIZATION_URL:</code> URL del proveedor de autenticación y autorización que utiliza Meltsan Solutions en sus productos</p>
</li>
<li>
<p><code>CLIENT_ID:</code> URL del proveedor de autenticación y autorización que utiliza Meltsan Solutions en sus productos</p>
</li>
<li>
<p><code>CLIENT_SECRET:</code> URL del proveedor de autenticación y autorización que utiliza Meltsan Solutions en sus productos</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Estos datos los puedes solicitar a:
    - <a href="mailto:contacto@meltsan.com">contacto@meltsan.com</a></p>
</div>
</div>
<div class="sect2">
<h3 id="ejemplos"><a class="anchor" href="#ejemplos"></a>1.2. Ejemplos</h3>
<div class="paragraph">
<p>Para obtener un token de acceso lo puedes realizar de las siguientes maneras:</p>
</div>
<div class="sect3">
<h4 id="curl"><a class="anchor" href="#curl"></a>1.2.1. CURL</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">curl "$AUTHORIZATION_URL" \
-d "client_id=$CLIENT_ID" \
-d "client_secret=$CLIENT_SECRET" \
-d "grant_type=client_credentials"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="kotlin"><a class="anchor" href="#kotlin"></a>1.2.2. Kotlin</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="kotlin" class="language-kotlin hljs">@FeignClient(
    name = "keycloak",
    url = "\${keycloak.authorizarion-url}",
    configuration = [KeycloakFeignService.FeignKeycloakDecoder::class]
)
interface KeycloakFeignService {

    @Throws(AmlSecurityException::class)
    @PostMapping(
        value = ["realms/\${keycloak.realm}/protocol/openid-connect/token"],
        consumes = [MediaType.APPLICATION_FORM_URLENCODED_VALUE],
        produces = [MediaType.APPLICATION_JSON_VALUE]
    )
    fun retrieveAccessToken(@RequestBody credentials: KeycloakCredReq): AccessTokenRes

    class FeignKeycloakDecoder {

        @Bean
        fun feignFormEncoder(converters: ObjectFactory&lt;HttpMessageConverters&gt;): Encoder {
            return SpringFormEncoder(SpringEncoder(converters))
        }

        @Bean
        fun errorDecoder(): ErrorDecoder {
            return ErrorDecoder { _, response -&gt;
                val errors = SecurityUtil.inputStreamToString(response)
                val detail = mutableListOf("Error Keycloak Service", errors)
                throw AmlSecurityException(
                    detail,
                    "Request to Keycloak Service",
                    Constant.MSG_ERR_KEYCLOAK,
                    HttpStatus.valueOf(response.status())
                )
            }
        }

    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>El objeto con las credenciales es la siguiente:
<code>KeycloakCredReq</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="kotlin" class="language-kotlin hljs">@Component
class KeycloakCredReq : Serializable {

    @Value("\${keycloak.resource}")
    lateinit var client_id: String

    @Value("\${keycloak.credentials.grant}")
    lateinit var grant_type: String

    @Value("\${keycloak.credentials.secret}")
    lateinit var client_secret: String
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="response"><a class="anchor" href="#response"></a>1.3. Response</h3>
<div class="paragraph">
<p>Cualquiera de estos ejemplos devolverá una respuesta en formato JSON de la siguiente manera</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "access_token": "$TOKEN",
  "expires_in": 1800,
  "refresh_expires_in": 0,
  "token_type": "Bearer",
  "not-before-policy": 0,
  "scope": "email profile"
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0.0<br>
Last updated 2022-05-14 13:37:30 -0500
</div>
</div>
<link rel="stylesheet" href="assets/js/highlight/styles/googlecode.min.css">
<script src="assets/js/highlight/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
<script type="text/javascript" src="assets/js/tocbot/tocbot.min.js"></script>
<script type="text/javascript" src="assets/js/toc.js"></script>
</body>
</html>